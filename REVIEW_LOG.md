# Testnet Review Log

This file tracks active review progress and decisions without bloating `DEPENDENCY_LAYERS.md`.

## Workflow Reminder

For each file:

1. Analyze
2. Present possible improvements
3. Wait for explicit approval
4. Implement

## Status Legend

- `not_started`: No analysis yet.
- `analyzing`: Reading and validating behavior.
- `proposed`: Improvements presented, waiting for approval.
- `approved`: Approved by user, implementation not started yet.
- `implemented`: Changes made.
- `verified`: Tests and validation complete.
- `blocked`: Cannot proceed due to dependency or open question.

## Layer Progress Table

| Layer | Status | Started (YYYY-MM-DD) | Completed (YYYY-MM-DD) | Notes |
| --- | --- | --- | --- | --- |
| L1 Security and Crypto | `verified` | 2026-02-12 | 2026-02-12 | All `core/src/security` files reviewed; test coverage hardening and doc cleanup completed across send/harbor/key modules. |
| L2 Data and Storage | `verified` | 2026-02-12 | 2026-02-12 | File-by-file review complete for `core/src/data` and `core/src/keychain`; integrity hardening, decode strictness, transactional safety, keychain error-surface cleanup, and targeted regression coverage added across the layer. |
| L3 Resilience | `verified` | 2026-02-12 | 2026-02-12 | File-by-file review complete for `core/src/resilience`; adaptive PoW tracking hardening, opportunistic rate-limit cleanup, strict storage decode/overflow handling, and production store-path eviction with regression coverage are in place. |
| L4 Network Primitives and Transport Helpers | `verified` | 2026-02-12 | 2026-02-12 | File-by-file review complete for `core/src/network/connect`, `core/src/network/pool`, `core/src/network/gate`, `core/src/network/rpc`, `core/src/network/process`, `core/src/network/wire`, `core/src/network/packet`, and `core/src/network/membership`; decode/verification hardening and regression coverage are in place. |
| L5 Network Services | `analyzing` | 2026-02-12 |  | Started file-by-file review with `core/src/network/send/mod.rs`; continuing through send/harbor/share/sync/stream/control/dht modules. |
| L6 Public API and Runtime | `not_started` |  |  |  |
| L7 Apps and Integrations | `not_started` |  |  |  |

## File-by-File Review Log

| Date | Layer | File | Phase | Key Findings | Proposed Improvements | Approval Status | Implementation Status | Test Coverage/Result | Perf Notes | Follow-ups |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 2026-02-12 | L1 | `core/src/security/send/packet.rs` | `verified` | Storage size bound drift; DM verification lacked explicit DM flag check; stale packet schema docs/comments. | Robust storage size envelope for Topic/DM, DM flag validation, doc/comment cleanup, added boundary and DM tests. | `approved` | `implemented` | `cargo test -p harbor-core --quiet` => 679 passed, 0 failed. | AAD stack-buffer optimization identified; deferred. | Continue with next L1 file (`core/src/security/send/seal.rs`). |
| 2026-02-12 | L1 | `core/src/security/send/seal.rs` | `verified` | Thin wrapper module is correct; no functional defects found. Module docs now distinguish topic sealing (with MAC) from DM sealing (no MAC). | Clarified module docs to separate topic vs DM crypto behavior; added tests for `seal_topic_packet_with_epoch` roundtrip and payload-too-large propagation for topic/DM seal helpers. | `approved` | `implemented` | `cargo test -p harbor-core security::send::seal --quiet` => 7 passed, 0 failed. | None identified in this file. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/send/mod.rs` | `verified` | Re-export module is structurally correct; no runtime defects. Docs now reflect current model: topic + DM crypto only (tier/MLS language removed). | Updated module docs/comments to separate topic-vs-DM behavior and removed outdated tier/MLS framing. Re-export surface unchanged. | `approved` | `implemented` | `cargo test -p harbor-core security::send --quiet` => 45 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/mod.rs` | `verified` | Facade/re-export module is structurally correct and heavily used across layers. Docs/comments now reflect topic+DM model and remove outdated tier framing. | Updated module docs and re-export comments to current topic/DM terminology; preserved API exports unchanged. | `approved` | `implemented` | `cargo test -p harbor-core security --quiet` => 101 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/create_key_pair.rs` | `verified` | Key generation/restore logic is sound; no functional defects found. Test suite now validates derivation against a known Ed25519 vector instead of a self-referential check. | Kept runtime code unchanged; replaced deterministic self-check with known private-key -> public-key vector assertion. | `approved` | `implemented` | `cargo test -p harbor-core security::create_key_pair --quiet` => 8 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/dm_keys.rs` | `verified` | DM ECDH+AEAD flow is correct. Removed panic path in encryption helper by propagating typed errors; added explicit error-shape tests for invalid public key and nonce-too-short ciphertext. | `seal_with_shared` now returns `Result` and maps AEAD failure to new `DmCryptoError::EncryptionFailed`; added tests for `InvalidPublicKey` and `InvalidCiphertext` paths. | `approved` | `implemented` | `cargo test -p harbor-core security::dm_keys --quiet` => 7 passed, 0 failed; `cargo test -p harbor-core security::send --quiet` => 45 passed, 0 failed. | Minor extra allocations in seal/open buffers noted; defer unless hot-path profiling indicates need. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/topic_keys.rs` | `verified` | Derivation and harbor-ID logic are correct. Doc wording now aligns with BLAKE3 keyed MAC terminology, and deterministic known-output vectors are pinned for topic key derivation and harbor ID. | Kept runtime logic unchanged; updated `k_mac` comment wording and added known-vector tests for `TopicKeys::derive` and `harbor_id_from_topic`. | `approved` | `implemented` | `cargo test -p harbor-core security::topic_keys --quiet` => 14 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/harbor/authenticate.rs` | `verified` | MAC creation logic is straightforward and correct; no runtime defects found. Test suite now includes a fixed known-output MAC vector to guard against accidental algorithm/API drift. | Kept production code unchanged; added one known-output vector test for `create_mac` with fixed key/message bytes. | `approved` | `implemented` | `cargo test -p harbor-core security::harbor::authenticate --quiet` => 6 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/harbor/encrypt.rs` | `verified` | AEAD encrypt/decrypt logic is correct and well-covered for failure modes. Added deterministic known-vector coverage for fixed key/nonce/AAD/plaintext to guard against accidental cryptographic API/parameter drift. | Kept production code unchanged; added one known-output vector test for AEAD encrypt/decrypt with fixed inputs and expected ciphertext+tag bytes. | `approved` | `implemented` | `cargo test -p harbor-core security::harbor::encrypt --quiet` => 15 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/harbor/sign.rs` | `verified` | Signing/verification logic is correct and tests pass. Invalid-public-key coverage is now deterministic, and a fixed known-output signature vector is pinned. | Kept production code unchanged; hardened invalid-key-path test by generating a guaranteed-invalid public key and added deterministic known-output signature vector test. | `approved` | `implemented` | `cargo test -p harbor-core security::harbor::sign --quiet` => 13 passed, 0 failed. | None. | Continue with next L1 file. |
| 2026-02-12 | L1 | `core/src/security/harbor/mod.rs` | `verified` | Facade module is structurally correct (submodule wiring + re-exports), with no runtime logic and no defects found. Docs are concise and accurate for current Harbor packet crypto stack. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | `cargo test -p harbor-core security::harbor --quiet` => 34 passed, 0 failed. | None. | L1 complete; proceed to L2 review. |
| 2026-02-12 | L2 | `core/src/data/mod.rs` | `verified` | Facade/re-export module is structurally correct; no runtime defects. Top-level docs contained stale `CRDT sync` mention. | Removed stale `CRDT sync documents` bullet and tightened module-organization wording; API exports unchanged. | `approved` | `implemented` | Not run (docs-only facade module; no behavior change). | None. | Continue with `core/src/data/start.rs`. |
| 2026-02-12 | L2 | `core/src/data/start.rs` | `verified` | DB init was gating schema creation on `peers` table existence, leaving partial-schema DBs unrecovered; security doc wording incorrectly said key PRAGMA used parameter binding. | Always run idempotent `create_all_tables`; correct key-PRAGMA safety docs; added partial-schema recovery regression test and tightened memory DB schema assertions. | `approved` | `implemented` | `cargo test -p harbor-core data::start --quiet` => 10 passed, 0 failed; `cargo test -p harbor-core --quiet` => 690 passed, 0 failed. | None. | Continue with `core/src/data/schema.rs`. |
| 2026-02-12 | L2 | `core/src/data/schema.rs` | `verified` | Schema definitions are structurally sound. Found stale comments implying all ID BLOBs are 32 bytes (while `packet_id` is 16 bytes in outgoing/harbor tables) and stale “Tier 1 placeholder” test heading; all-tables test missed explicit share/harbor-nodes coverage. | Corrected schema docs/comments for ID sizes, removed stale placeholder wording, and strengthened `test_create_all_tables` assertions to include `harbor_nodes_cache`, `blobs`, `blob_recipients`, and `blob_sections`. | `approved` | `implemented` | `cargo test -p harbor-core data::schema --quiet` => 14 passed, 0 failed. | None. | Continue with `core/src/data/identity.rs`. |
| 2026-02-12 | L2 | `core/src/data/identity.rs` | `verified` | `get_or_create_identity` had a startup race window (read-then-insert) that could fail under concurrent initializations; malformed key-size errors always reported private-key column even when public key was invalid. | Made identity creation race-tolerant by recovering from constraint conflicts via reload; fixed column-specific malformed-key error reporting; added tests for `ensure_self_in_peers` idempotency and invalid private/public key sizes. | `approved` | `implemented` | `cargo test -p harbor-core data::identity --quiet` => 11 passed, 0 failed; `cargo test -p harbor-core --quiet` => 693 passed, 0 failed. | None. | Continue with `core/src/data/control/mod.rs`. |
| 2026-02-12 | L2 | `core/src/data/control/mod.rs` | `verified` | Decode paths silently coerced malformed blobs to zero IDs and unknown states to `Declined`; pending-invite member blob parsing dropped trailing bytes silently; negative stored epochs could wrap to huge `u64` values. | Introduced strict decode helpers (fixed-size ID decoding, strict state parsing, epoch non-negative validation, exact members-blob alignment); removed silent fallback coercions and added corruption-path tests for invalid state, token length, malformed members blob, and negative epoch. | `approved` | `implemented` | `cargo test -p harbor-core data::control --quiet` => 7 passed, 0 failed; `cargo test -p harbor-core --quiet` => 697 passed, 0 failed. | None. | Continue with `core/src/data/dht/mod.rs`. |
| 2026-02-12 | L2 | `core/src/data/dht/mod.rs` | `verified` | Facade module is structurally correct (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | Not run (facade-only module; no behavior change). | None. | Continue with `core/src/data/dht/peer.rs`. |
| 2026-02-12 | L2 | `core/src/data/dht/peer.rs` | `verified` | `upsert_peer` could regress `last_seen` with older inputs; stale-peer cleanup could fail under FK constraints if stale peers were still referenced by non-cascading tables; relay timestamp monotonic behavior was untested. | Made `last_seen` monotonic in upsert (`MAX(existing, incoming)`), hardened stale cleanup to skip peers referenced by non-cascading FK tables, enabled FK-aware full-schema test setup, and added tests for monotonic `last_seen`, relay update timestamp ordering, and referenced-stale-peer cleanup behavior. | `approved` | `implemented` | `cargo test -p harbor-core data::dht::peer --quiet` => 9 passed, 0 failed; `cargo test -p harbor-core --quiet` => 700 passed, 0 failed. | Cleanup query is broader; acceptable for periodic maintenance path. | Continue with `core/src/data/dht/routing.rs`. |
| 2026-02-12 | L2 | `core/src/data/dht/routing.rs` | `verified` | Bucket index parsing accepted out-of-range DB integers via unchecked cast; relay-url loader docs were out of sync with the tuple return shape. | Added strict `bucket_index` range validation (0..=255) in row parser, corrected relay URL loader docs to describe `(endpoint_id, relay_url, relay_url_last_success)`, and added tests for auto-creating peers on insert and rejecting corrupt bucket indices. | `approved` | `implemented` | `cargo test -p harbor-core data::dht::routing --quiet` => 10 passed, 0 failed; `cargo test -p harbor-core --quiet` => 702 passed, 0 failed. | None. | Continue with `core/src/data/harbor/mod.rs`. |
| 2026-02-12 | L2 | `core/src/data/harbor/mod.rs` | `verified` | Facade module is structurally correct (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | Not run (facade-only module; no behavior change). | None. | Continue with `core/src/data/harbor/cache.rs`. |
| 2026-02-12 | L2 | `core/src/data/harbor/cache.rs` | `verified` | Custom TTL path accepted negative/overflow values for `expires_at`, and blob parse errors reported less-useful column diagnostics. | Added TTL validation (`ttl_secs >= 0`) and checked expiration arithmetic, switched parsing to column-aware helpers for better corruption diagnostics, and added tests for negative TTL and overflow TTL rejection. | `approved` | `implemented` | `cargo test -p harbor-core data::harbor::cache --quiet` => 16 passed, 0 failed; `cargo test -p harbor-core --quiet` => 704 passed, 0 failed. | None. | Continue with `core/src/data/harbor/dedup.rs`. |
| 2026-02-12 | L2 | `core/src/data/harbor/dedup.rs` | `verified` | Dedup check/mark path was non-atomic (`was_pulled` then `mark_pulled`), allowing duplicate `Process` decisions under concurrency race; test setup lacked FK parity with other L2 modules. | Replaced read-then-write with atomic `INSERT OR IGNORE` on `pulled_packets` and row-count decision (`Process` vs `AlreadySeen`), enabled FK pragma in test setup, and added pre-marked packet regression test. | `approved` | `implemented` | `cargo test -p harbor-core data::harbor::dedup --quiet` => 13 passed, 0 failed; `cargo test -p harbor-core --quiet` => 705 passed, 0 failed. | None. | Continue with `core/src/data/harbor/nodes.rs`. |
| 2026-02-12 | L2 | `core/src/data/harbor/nodes.rs` | `verified` | Cached-node and active-harbor decode paths could panic on malformed blob lengths; replace path was non-atomic (`DELETE` then inserts), allowing partial cache state on mid-write failure; comments were stale about callers; test setup lacked FK parity. | Added strict fixed-32 decode helper with typed DB errors, wrapped replace flow in a transaction for atomic delete+insert, refreshed docs to include fallback callers, enabled FK pragma in test setup, and added tests for distinct harbor IDs, malformed blob rejection, and transaction rollback on forced insert failure. | `approved` | `implemented` | `cargo test -p harbor-core data::harbor::nodes --quiet` => 8 passed, 0 failed; `cargo test -p harbor-core data::harbor --quiet` => 37 passed, 0 failed. | Transaction reduces write churn and prevents partial updates. | Continue with `core/src/data/membership/mod.rs`. |
| 2026-02-12 | L2 | `core/src/data/membership/mod.rs` | `verified` | Facade module only (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | `cargo test -p harbor-core data::membership --quiet` => 19 passed, 0 failed. | None. | Continue with `core/src/data/membership/topic.rs`. |
| 2026-02-12 | L2 | `core/src/data/membership/topic.rs` | `verified` | Legacy placeholder-admin rows were never upgraded because `subscribe_topic_with_admin` only used `INSERT OR IGNORE`; topic insert + epoch-0 key store were non-atomic; repeated member adds rewrote `joined_at`. | Made topic subscribe/init atomic via transaction, added one-way placeholder-admin upgrade to real admin, switched member insert paths to idempotent `INSERT OR IGNORE` to preserve `joined_at`, and added regression tests for admin upgrade/non-override, transactional rollback, DM-topic no-epoch behavior, and idempotent member add semantics. | `approved` | `implemented` | `cargo test -p harbor-core data::membership::topic --quiet` => 18 passed, 0 failed; `cargo test -p harbor-core data::membership --quiet` => 24 passed, 0 failed. | None. | Continue with `core/src/data/membership/epoch.rs`. |
| 2026-02-12 | L2 | `core/src/data/membership/epoch.rs` | `verified` | Epoch row decoding had panic paths on malformed blob lengths and unchecked signed/unsigned epoch casts could accept corrupt negative DB epochs or overflow on large input epoch values; expiry math lacked overflow guard. | Added strict row decoding helpers (fixed-size blob checks + non-negative epoch validation), bounded epoch SQL encoding (`u64` -> `i64` with error on overflow), checked `expires_at` arithmetic, and added corruption/range regression tests for malformed blob lengths, negative stored epochs, and oversized epoch input rejection. | `approved` | `implemented` | `cargo test -p harbor-core data::membership::epoch --quiet` => 10 passed, 0 failed; `cargo test -p harbor-core data::membership --quiet` => 28 passed, 0 failed. | None. | Continue with `core/src/data/send/mod.rs`. |
| 2026-02-12 | L2 | `core/src/data/send/mod.rs` | `verified` | Facade module only (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | `cargo test -p harbor-core data::send --quiet` => 7 passed, 0 failed. | None. | Continue with `core/src/data/send/outgoing.rs`. |
| 2026-02-12 | L2 | `core/src/data/send/outgoing.rs` | `verified` | Missing-packet ack cleanup could report deleted=true even when no row existed; packet row decode accepted out-of-range numeric values via unchecked casts; packet-type docs were stale vs current payload-embedded typing. | Made ack-complete check require packet existence and return actual delete result, added strict integer decoding for `replicated_to_harbor` and `packet_type`, refreshed packet-type docs, and added regressions for missing-packet ack semantics plus invalid numeric decode paths. | `approved` | `implemented` | `cargo test -p harbor-core data::send::outgoing --quiet` => 11 passed, 0 failed; `cargo test -p harbor-core data::send --quiet` => 11 passed, 0 failed. | None. | Continue with next L2 file. |
| 2026-02-12 | L2 | `core/src/data/share/mod.rs` | `verified` | Facade module only (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | Not run (facade-only module; no behavior change). | None. | Continue with `core/src/data/share/metadata.rs`. |
| 2026-02-12 | L2 | `core/src/data/share/metadata.rs` | `verified` | `num_sections == 0` could panic in section init; blob upsert used `INSERT OR REPLACE` and could drop recipient/section rows via cascade; decode paths had unchecked blob-length and signed/unsigned casts that could panic or silently coerce corrupt DB data. | Added strict decode helpers for fixed-size IDs and numeric/state parsing, rejected zero sections in init/seeder flows, switched blob write to non-destructive upsert (`ON CONFLICT DO UPDATE`) to preserve child rows, and added regressions for zero-sections rejection, invalid state/negative size decode errors, child-row preservation across upsert, and malformed ID length parsing. | `approved` | `implemented` | `cargo test -p harbor-core data::share::metadata --quiet` => 15 passed, 0 failed; `cargo test -p harbor-core data::share --quiet` => 40 passed, 0 failed. | None. | Continue with `core/src/data/share/blob_store.rs`. |
| 2026-02-12 | L2 | `core/src/data/share/blob_store.rs` | `verified` | Chunk writes accepted out-of-range indices and mismatched lengths (possible sparse-file blowup/corruption); imported outboard layout was inconsistent with runtime verify/update layout; verify path accepted truncated/zero entries as valid; import could leave partial file sets on failure. | Added strict chunk bounds/size validation in `write_chunk`, normalized outboard format to fixed 32-byte per-chunk hashes, made verify fail-closed for missing/truncated/zero hash entries, switched sizes map to per-chunk byte lengths, hardened import to staged temp-file replacement with cleanup-on-error, and refreshed stale module/docs/comments. | `approved` | `implemented` | `cargo test -p harbor-core data::share::blob_store --quiet` => 30 passed, 0 failed; `cargo test -p harbor-core data::share --quiet` => 45 passed, 0 failed. | Verification now requires outboard/hash-index availability (no compatibility fallback). | Continue with next L2 file. |
| 2026-02-12 | L2 | `core/src/keychain/mod.rs` | `verified` | Facade module only (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | Not run (facade-only module; no behavior change). | None. | Continue with `core/src/keychain/error.rs`. |
| 2026-02-12 | L2 | `core/src/keychain/error.rs` | `verified` | `NotFound` variant was dead API surface (missing credential is modeled as `Ok(None)`); retrieve failures were mapped to `NotAvailable`, blurring service-availability vs operation errors. | Replaced `NotFound` with `RetrieveError(String)` and updated retrieve mapping accordingly; added focused unit tests through internal mapping seams in `keychain/service.rs` for retrieve/delete error-shape behavior. | `approved` | `implemented` | `cargo test -p harbor-core keychain --quiet` => 5 passed, 0 failed. | None. | Continue with `core/src/keychain/service.rs`. |
| 2026-02-12 | L2 | `core/src/keychain/service.rs` | `verified` | Boolean presence helper swallowed keychain errors; keychain entry identifiers were fixed constants across environments; public-function error semantics lacked direct unit coverage. | Added fallible `has_stored_passphrase_result()` and retained bool wrapper for compatibility, introduced configurable keychain identifiers via `HARBOR_KEYCHAIN_SERVICE`/`HARBOR_KEYCHAIN_USER` with namespaced defaults, and expanded unit tests for presence-result mapping and identifier resolution. | `approved` | `implemented` | `cargo test -p harbor-core keychain --quiet` => 10 passed, 0 failed. | None. | Continue with next L2 file. |
| 2026-02-12 | L3 | `core/src/resilience/mod.rs` | `verified` | Facade module only (submodule wiring + re-exports), with no runtime logic or defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | Not run (facade-only module; no behavior change). | None. | Continue with `core/src/resilience/proof_of_work.rs`. |
| 2026-02-12 | L3 | `core/src/resilience/proof_of_work.rs` | `verified` | Adaptive scaling could remain inert in runtime because successful verifications were not recorded; scaling increments used wrapping `u64 -> u8` casts; `InvalidContext` result variant was dead surface and never emitted. | Switched scaling arithmetic to saturating conversions, made successful PoW verification paths record per-peer scaling state (minimal companion edits in Harbor/Control/DHT/Send services), removed dead `InvalidContext` branch, prevented no-op scaling modes from retaining peer state, and added regressions for wraparound-resistant scaling and no-scaling tracking behavior. | `approved` | `implemented` | `cargo test -p harbor-core resilience::proof_of_work --quiet` => 23 passed, 0 failed; `cargo test -p harbor-core resilience --quiet` => 49 passed, 0 failed; service-focused suites: `network::harbor::service` (14), `network::control::service` (3), `network::send::service` (8), `network::dht::service` (0 selected) all passed. | None. | Continue with next L3 file (`core/src/resilience/rate_limit.rs`). |
| 2026-02-12 | L3 | `core/src/resilience/rate_limit.rs` | `verified` | Cleanup depended on manual calls with no production call sites, enabling stale-key buildup under high endpoint/harbor churn; cleanup retention math used non-saturating duration multiplication; request-order semantics for combined checks were implicit. | Added opportunistic auto-cleanup trigger during check paths, switched cleanup retention math to saturating duration handling, documented that combined store checks consume connection budget first, documented zero-limit deny-all behavior, and added regressions for auto-cleanup, extreme-duration cleanup safety, connection-budget consumption ordering, and zero-limit semantics. | `approved` | `implemented` | `cargo test -p harbor-core resilience::rate_limit --quiet` => 12 passed, 0 failed; `cargo test -p harbor-core resilience --quiet` => 53 passed, 0 failed. | Auto-cleanup runs every 64 checks to balance memory control and hot-path overhead. | Continue with next L3 file (`core/src/resilience/storage.rs`). |
| 2026-02-12 | L3 | `core/src/resilience/storage.rs` | `verified` | Decode paths silently dropped malformed rows and used unchecked signed/unsigned casts; quota math used unchecked addition; runtime Harbor store path only rejected on quota exceed and never attempted eviction. | Added strict fixed-size ID and non-negative integer decode helpers with fail-closed DB errors, replaced unchecked math with overflow-aware checks, made eviction selection/byte accounting saturating and non-silent, updated stale default-storage docs, added corruption/overflow regressions, and wired production Harbor store handling to perform quota-specific eviction + re-check before rejecting. | `approved` | `implemented` | `cargo test -p harbor-core resilience::storage --quiet` => 21 passed, 0 failed; `cargo test -p harbor-core network::harbor::service --quiet` => 15 passed, 0 failed; `cargo test -p harbor-core network::harbor::incoming --quiet` => 12 passed, 0 failed; `cargo test -p harbor-core resilience --quiet` => 56 passed, 0 failed. | Eviction candidate dedupe now uses `HashSet` to avoid quadratic scans on larger candidate sets. | L3 complete; proceed to L4 review. |
| 2026-02-12 | L4 | `core/src/network/connect.rs` | `verified` | Relay hints without known-success timestamps were effectively ignored by freshness gating; pooled connector path ignored per-call timeout overrides; relay-info DB read/write failures were silently swallowed; split timeout could drop to zero for tiny timeout values. | Added explicit relay-hint resolution that still attempts hinted relay first when unverified, threaded caller timeout through pooled connect path via `ConnectionPool::get_connection_with_timeout` companion edit, added warning logs for relay-info DB read/write/parse failures, guarded split timeout against accidental zero-duration attempts, and added focused unit tests for hint resolution and timeout splitting behavior. | `approved` | `implemented` | `cargo test -p harbor-core network::connect --quiet` => 3 passed, 0 failed; `cargo test -p harbor-core network::pool --quiet` => 2 passed, 0 failed; `cargo test -p harbor-core --quiet` => 757 passed, 0 failed. | None. | Continue with next L4 file (`core/src/network/pool.rs`). |
| 2026-02-12 | L4 | `core/src/network/pool.rs` | `verified` | Cached-connection reuse did not refresh `last_used`/LRU ordering, enabling active connections to be treated as evictable; closed cached entries could linger and consume pool capacity; eviction path only inspected the front entry and did not robustly clean stale/closed LRU entries. | Updated cache-hit path to refresh `last_used` and LRU order, added closed-entry pruning in acquisition/cache paths, strengthened eviction scanning to clean stale/closed entries while preserving active oldest entries, made `stats()` report live (not merely stored) connections, and added helper-focused tests for LRU touch/remove behavior. | `approved` | `implemented` | `cargo test -p harbor-core network::pool --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::connect --quiet` => 3 passed, 0 failed; `cargo test -p harbor-core --quiet` => 759 passed, 0 failed. | None. | Continue with next L4 file (`core/src/network/gate.rs`). |
| 2026-02-12 | L4 | `core/src/network/gate.rs` | `verified` | DM blocked precedence relied on separate lock reads/writes, allowing a permissive transition window under interleaving; startup DB load path silently ignored failures; batch add logging used input count instead of effective inserts after self-filtering. | Hardened blocked precedence by keeping blocked guard through authorization decision and using consistent blocked→connected lock ordering in DM transition updates; added warning logs for DB load failures (connected/blocked/topic/member loads); corrected batch add count to reflect effective inserts; expanded tests for blocked-overrides-connected+topic and batch self-skip behavior. | `approved` | `implemented` | `cargo test -p harbor-core network::gate --quiet` => 7 passed, 0 failed; `cargo test -p harbor-core handlers::send --quiet` => 2 passed, 0 failed; `cargo test -p harbor-core --quiet` => 761 passed, 0 failed. | None. | Continue with next L4 file (`core/src/network/rpc.rs`). |
| 2026-02-12 | L4 | `core/src/network/rpc.rs` | `verified` | Adapter module is structurally correct (existing-connection wrapper for irpc `RemoteConnection`), with minimal logic and no runtime defects found. | No code changes needed; reviewed and verified as-is. | `approved` | `implemented` | Not run (no behavior change in this file). | None. | Continue with next L4 file (`core/src/network/process.rs`). |
| 2026-02-12 | L4 | `core/src/network/process.rs` | `verified` | Harbor control-path handlers were missing sender-id validation for several packet types (`ConnectRequest/Accept/Decline`, `TopicInvite`, `Suggest`), `RemoveMember` lacked topic-admin authorization check, and several critical control/membership DB mutations were silently ignored. | Added strict sender validation for Harbor control handlers, enforced topic-admin authorization for `RemoveMember`, propagated critical DB write failures as `ProcessError::Database` instead of silently discarding them, refreshed stale module docs, and added focused unit tests for sender validation and authorization error display. | `approved` | `implemented` | `cargo test -p harbor-core network::process --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::harbor::client --quiet` => 12 passed, 0 failed; `cargo test -p harbor-core --quiet` => 764 passed, 0 failed. | None. | Continue with next L4 file (`core/src/network/wire.rs`). |
| 2026-02-12 | L4 | `core/src/network/wire.rs` | `verified` | Frame encoding used unchecked `usize -> u32` cast (silent truncation risk for oversized payloads), total-size math used unchecked addition, and the wire primitive had no direct unit tests. | Added checked payload-length conversion and checked frame-size arithmetic with explicit `FrameError` variants, updated share-protocol error mapping for new wire errors, and added focused wire-frame tests for roundtrip, truncation, trailing-bytes behavior, and overflow guards. | `approved` | `implemented` | `cargo test -p harbor-core network::wire --quiet` => 7 passed, 0 failed; `cargo test -p harbor-core network::share::protocol --quiet` => 17 passed, 0 failed; `cargo test -p harbor-core network::sync::protocol --quiet` => 13 passed, 0 failed. | None. | Continue with next L4 file (`core/src/network/packet.rs`). |
| 2026-02-12 | L4 | `core/src/network/packet.rs` | `verified` | Structured payload decoders accepted trailing bytes silently, sync-request decoders accepted unexpected payload bytes, and DM/stream helper classifiers accepted reserved bytes by range. | Switched structured decodes to strict `postcard::take_from_bytes` with trailing-byte rejection, enforced empty payload for `TopicSyncRequest`/`DmSyncRequest`, tightened DM/stream classifier helpers to only recognize defined packet variants, and added regression/invariant tests for strict decode and packet metadata semantics. | `approved` | `implemented` | `cargo test -p harbor-core network::packet --quiet` => 27 passed, 0 failed; `cargo test -p harbor-core network::process --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::send --quiet` => 13 passed, 0 failed. | None. | Continue with next L4 file (`core/src/network/membership`). |
| 2026-02-12 | L4 | `core/src/network/membership.rs` | `verified` | Membership proof verification used non-constant-time equality and the helper module lacked direct tests for proof/binding invariants. | Switched verification to constant-time equality (`subtle::ConstantTimeEq`) and added direct tests for roundtrip, mismatched inputs, tampered proof rejection, and `create_membership_binding` correctness. | `approved` | `implemented` | `cargo test -p harbor-core network::membership --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::send::protocol --quiet` => 5 passed, 0 failed; `cargo test -p harbor-core network::process --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::sync::service --quiet` => 8 passed, 0 failed. | None. | L4 complete; proceed to L5 review (`core/src/network/send/mod.rs`). |
| 2026-02-12 | L5 | `core/src/network/send/mod.rs` | `verified` | Facade/re-export module is structurally correct with no runtime logic defects; Harbor-storage docs overstated DM sealing as MAC-backed. | Updated module docs to distinguish Harbor sealing semantics by message class (topic: encrypt + MAC + sign; DM: encrypt + sign), with API/re-export surface unchanged. | `approved` | `implemented` | Not run (docs-only facade module; no behavior change). | None. | Continue with `core/src/network/send/protocol.rs`. |
| 2026-02-12 | L5 | `core/src/network/send/protocol.rs` | `verified` | Wire types and RPC enum are structurally correct with no runtime defects in this file; `Receipt` docs implied delivery success while handlers also acknowledge rejected/skipped packets. | Updated `Receipt` docs to reflect packet reception semantics; wire/API behavior unchanged. | `approved` | `implemented` | Not run (docs-only clarification; no behavior change). | None. | Continue with `core/src/network/send/service.rs`. |
| 2026-02-12 | L5 | `core/src/network/send/service.rs` | `verified` | PoW verification had panic risk on poisoned mutex (`lock().unwrap()`), and docs implied active TTL/config enforcement that is not currently wired in send runtime paths. | Replaced panic-prone PoW mutex acquisition with poison-tolerant recovery helper, added a regression test that validates recovery from a poisoned verifier mutex, and clarified `SendOptions::ttl` / `SendConfig` docs as reserved compatibility knobs (no runtime semantic change). | `approved` | `implemented` | `cargo test -p harbor-core network::send::service --quiet` => 9 passed, 0 failed. | None. | Continue with `core/src/network/send/topic.rs`. |
| 2026-02-12 | L5 | `core/src/network/send/topic.rs` | `verified` | Topic send path treated any RPC response as successful delivery without validating receipt fields or persisting direct-delivery receipts; dedup and blob-lookup DB failures were handled opaquely (`unwrap_or` / `is_ok+unwrap`). | Added strict receipt validation (`packet_id` + sender match), persisted valid direct-delivery receipts back to outgoing tracking (with Harbor fallback on persistence failure), replaced dedup fallback with explicit fail-open logging, refactored blob lookup handling to explicit known/missing/error branches, and added targeted unit tests for receipt validation/persistence plus dedup/blob error-classification helpers. | `approved` | `implemented` | `cargo test -p harbor-core network::send::topic --quiet` => 6 passed, 0 failed; `cargo test -p harbor-core network::send --quiet` => 20 passed, 0 failed. | None. | Continue with `core/src/network/send/dm.rs`. |
| 2026-02-12 | L5 | `core/src/network/send/dm.rs` | `verified` | DM direct-send path accepted any RPC response as success without validating/persisting receipts; incoming dedup fallback was silent fail-open via `unwrap_or`. | Added strict DM receipt validation (`packet_id` + sender match), persisted valid direct-delivery receipts to outgoing tracking, replaced dedup fallback with explicit fail-open diagnostic helper, and added focused unit tests for receipt validation/persistence and dedup fallback behavior. | `approved` | `implemented` | `cargo test -p harbor-core network::send::dm --quiet` => 5 passed, 0 failed; `cargo test -p harbor-core network::send --quiet` => 25 passed, 0 failed. | None. | Continue with `core/src/network/harbor/mod.rs`. |
| 2026-02-12 | L5 | `core/src/network/harbor/mod.rs` | `verified` | Facade module is structurally correct with no runtime logic; top-level docs hardcoded replication count (“10 Harbor Nodes”) while runtime replication is config-driven. | Updated module docs to describe replication as configured rather than fixed-count; exports/API unchanged. | `approved` | `implemented` | Not run (docs-only facade module; no behavior change). | None. | Continue with `core/src/network/harbor/protocol.rs`. |
| 2026-02-12 | L5 | `core/src/network/harbor/protocol.rs` | `verified` | Message codec API exposed panic-prone `encode()` path for production call sites; compatibility assumptions around missing defaulted fields needed explicit coverage under postcard semantics. | Added fallible `HarborMessage::try_encode()`, switched harbor handler/network call sites to use fallible encoding with explicit error handling, retained `encode()` for compatibility, and expanded protocol tests for `try_encode` parity plus fail-closed decoding of legacy truncated payload shapes. | `approved` | `implemented` | `cargo test -p harbor-core network::harbor::protocol --quiet` => 18 passed, 0 failed; `cargo test -p harbor-core network::harbor --quiet` => 57 passed, 0 failed. | None. | Continue with `core/src/network/harbor/service.rs`. |
| 2026-02-12 | L5 | `core/src/network/harbor/service.rs` | `verified` | Harbor PoW verification used panic-prone mutex acquisition (`lock().unwrap()`), allowing potential process abort on poisoned lock state. | Replaced PoW verifier lock acquisition with poison-tolerant helper and added a regression test that validates recovery after mutex poisoning; service behavior/API unchanged. | `approved` | `implemented` | `cargo test -p harbor-core network::harbor::service --quiet` => 16 passed, 0 failed; `cargo test -p harbor-core network::harbor --quiet` => 58 passed, 0 failed. | None. | Continue with `core/src/network/harbor/incoming.rs`. |
| 2026-02-12 | L5 | `core/src/network/harbor/incoming.rs` | `verified` | Store handler could evict cached packets before validating malformed requests; rate limiter used panic-prone mutex locking; store path trusted claimed sender identity; sync delivery update application ignored DB outcomes; ack path treated unmatched acks as normal progress. | Added authenticated store entry point and wired handler dispatch to pass QUIC-authenticated sender ID, made rate-limiter lock poison-tolerant, reordered storage-capacity checks to run only after store request validation/verification, made sync update application propagate DB errors and count only successful marks, and hardened ack handling for unmatched/duplicate deliveries with explicit logging; refreshed stale member-sync comment. | `approved` | `implemented` | `cargo test -p harbor-core network::harbor::incoming --quiet` => 16 passed, 0 failed; `cargo test -p harbor-core network::harbor --quiet` => 62 passed, 0 failed. | None. | Continue with `core/src/network/harbor/network.rs`. |
| 2026-02-12 | L5 | `core/src/network/harbor/network.rs` | `verified` | Sync client used bidirectional streams while Harbor server accepts unidirectional request streams; response body reads lacked timeout bounds; store/pull/sync accepted uncorrelated response IDs; sync path bypassed protocol encode/decode helpers. | Switched sync transport to uni-request/uni-response parity, added response-read timeouts for store/pull/sync, enforced packet/harbor ID correlation checks on responses, normalized sync codec usage to `HarborMessage::try_encode/decode`, and added focused unit coverage for response-validation helpers. | `approved` | `implemented` | `cargo test -p harbor-core network::harbor::network --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::harbor --quiet` => 66 passed, 0 failed. | None. | Continue with `core/src/network/harbor/client.rs`. |
| 2026-02-12 | L5 | `core/src/network/harbor/client.rs` | `verified` | Pulled-packet processing trusted metadata `sender_id` without binding to signed packet sender; topic pull decryption allowed broad Full→MacOnly fallback; sync response update application ignored DB outcomes and overcounted applied updates; synced packet recipient defaults were ambiguous for unknown packets. | Added pulled-sender identity binding (`PacketInfo.sender_id` must match signed packet sender), narrowed topic MacOnly fallback to signature-failure cases for `TopicJoin` only, made sync delivery update application propagate DB errors and count only successful marks, derived safe recipient defaults for missing synced packets (DM recipient or wildcard for topic/legacy payloads), and refreshed stale member-sync comment; added targeted regression tests for sender-binding, fallback policy, and DM recipient defaulting. | `approved` | `implemented` | `cargo test -p harbor-core network::harbor::client --quiet` => 16 passed, 0 failed; `cargo test -p harbor-core network::harbor --quiet` => 70 passed, 0 failed. | None. | Continue with next L5 file. |
| 2026-02-12 | L5 | `core/src/network/share/mod.rs` | `verified` | Facade module only (submodule wiring + re-exports), with no runtime logic or defects found; module docs align with current share size floor semantics. | No code changes needed; reviewed and verified as-is. Optional repo-hygiene follow-up: remove uncompiled `service.rs.backup` file. | `approved` | `implemented` | Not run (facade-only module; no behavior change). | None. | Continue with `core/src/network/share/protocol.rs`. |
| 2026-02-12 | L5 | `core/src/network/share/protocol.rs` | `verified` | Share decode accepted trailing frame bytes in single-message paths, structured payload decodes did not enforce full payload consumption, file-announcement decode allowed bytes beyond declared payload length, and one note pointed at an outdated module path. | Hardened share decode semantics by making `ShareMessage::decode` exact-frame only (`decode_frame_exact`), introduced strict structured payload decoding via `postcard::take_from_bytes` with trailing-byte rejection, required exact declared-length consumption in `FileAnnouncement::decode`, and updated stale note text to `network/packet.rs`; added focused regressions for trailing-frame rejection, decode-with-size concatenated-frame parsing, trailing-payload rejection, and file-announcement trailing-byte rejection. | `approved` | `implemented` | `cargo test -p harbor-core network::share::protocol --quiet` => 21 passed, 0 failed; `cargo test -p harbor-core network::share --quiet` => 23 passed, 0 failed. | None. | Continue with `core/src/network/share/service.rs`. |
| 2026-02-12 | L5 | `core/src/network/share/service.rs` | `verified` | Sync export path used `block_on` over async DB mutex (runtime blocking risk), join-failure mapping on async export used misleading `Connection` error class, stale/dead transfer tracking retained live connections without read/cleanup paths, and service API contained unused dead surface (`set_send_service`, `AllPeersBusy`, `ProcessShareError`). | Replaced sync export DB access with fail-fast `try_lock` helper + explicit guidance to use async export when busy, centralized completeness guard for sync/async export paths, mapped export join failures to `Protocol` with export-specific context, removed stale transfer-state fields/types and companion insertion path in `network/share/distribute.rs`, removed dead service API variants/symbols, and updated `network/share/mod.rs` re-export list accordingly; added focused unit coverage for completeness guard, busy-lock fail-fast behavior, and join-error mapping. | `approved` | `implemented` | `cargo test -p harbor-core network::share::service --quiet` => 5 passed, 0 failed; `cargo test -p harbor-core network::share --quiet` => 26 passed, 0 failed. | None. | Continue with `core/src/network/share/distribute.rs`. |
| 2026-02-12 | L5 | `core/src/network/share/distribute.rs` | `verified` | Active share path (`share_file`) did not initialize `blob_sections`, section/push planning used hardcoded caps inconsistent with `ShareConfig`, and import logic was duplicated/divergent across `import_file` vs `share_file`; section math also relied on unchecked casts and zero-section assumptions. | Introduced shared import/persistence helpers for both flows, made persistence always initialize sections + mark complete, switched section and initial-push planning to config-aware bounds, hardened section/chunk calculations (overflow-safe chunk count + zero-section checks), aligned push connect timeout with `ShareConfig`, and surfaced stream finish errors; added focused helper tests for section planning, chunk-count overflow handling, and metadata persistence invariants. | `approved` | `implemented` | `cargo test -p harbor-core network::share::distribute --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::share --quiet` => 30 passed, 0 failed. | Avoided extra section-range reallocations by centralizing bounds helpers; no further perf work required in this file. | Continue with next L5 file. |
| 2026-02-12 | L5 | `core/src/network/share/acquire.rs` | `verified` | Pull section trace mapping used hardcoded section counts instead of blob metadata layout, pull RPC response handlers did not validate hash/chunk correlation, response reads lacked timeout bounds, and critical blob-store error paths were silently downgraded via `unwrap_or(...)`. | Switched acquire trace mapping to explicit metadata-driven section layout helper, added strict response correlation checks for chunk and chunk-map RPC replies, wrapped pull response reads with `chunk_timeout` bounds, replaced silent critical fallbacks with propagated errors, and improved trace-write diagnostics; added focused helper tests for section mapping, response validation mismatch handling, and chunk-map hash correlation. | `approved` | `implemented` | `cargo test -p harbor-core network::share::acquire --quiet` => 5 passed, 0 failed; `cargo test -p harbor-core network::share --quiet` => 35 passed, 0 failed. | Pull planning still uses per-peer filtering over missing chunk sets; defer optimization unless profiling shows this path hot. | Continue with `core/src/network/share/incoming.rs`. |
| 2026-02-12 | L5 | `core/src/network/share/incoming.rs` | `verified` | Inbound chunk serving could return missing sparse chunks because handler only checked blob existence, inbound chunk responses accepted/acked data from unknown senders, completion checks silently downgraded storage errors, and chunk-map DB failures were dropped without diagnostics. | Added chunk-availability gating before `ChunkResponse` serving, enforced known-sender checks for inbound chunk responses (source or traced seeder), made chunk verification fail-closed when outboard is present while allowing compatibility fallback when outboard is absent, replaced silent completion fallbacks with explicit warning paths, and surfaced chunk-map DB failure logs; companion transport edit in `core/src/handlers/share.rs` now accepts uni streams for push-style chunk responses and safely drops response-capable message types on uni streams; added focused unit coverage in both files. | `approved` | `implemented` | `cargo test -p harbor-core network::share::incoming --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core handlers::share --quiet` => 2 passed, 0 failed; `cargo test -p harbor-core network::share --quiet` => 39 passed, 0 failed. | No meaningful perf impact; new checks run on existing read/write paths only. | Continue with next L5 file. |
| 2026-02-12 | L2 | `core/src/data/control/mod.rs` | `verified` | `store_pending_invite` used unchecked `u64 -> i64` epoch cast, allowing out-of-range epochs to wrap negative and poison pending-invite reads. | Added checked epoch encoding helper for invite writes (`u64` must fit `i64`) and a regression test that rejects overflow epoch input and confirms no row is persisted. | `approved` | `implemented` | `cargo test -p harbor-core data::control --quiet` => 8 passed, 0 failed. | None. | Continue with next L5 file. |
| 2026-02-12 | L5 | `core/src/network/control/mod.rs` | `verified` | Facade module is structurally correct with no runtime logic defects; top-level docs implied only direct CONTROL_ALPN RPC flow and module list omitted `types.rs`. | Updated module docs to describe both direct RPC and Harbor-replicated control delivery paths, and added `types.rs` to module-structure docs; exports/API unchanged. | `approved` | `implemented` | Not run (docs-only facade module; no behavior change). | None. | Continue with `core/src/network/control/protocol.rs`. |
| 2026-02-12 | L5 | `core/src/network/control/protocol.rs` | `verified` | Wire schema/types are structurally sound; risk of future drift between `ControlPacketType` bytes and `PacketType` dispatch mapping lacked explicit regression guard. Top-level docs also implied strictly one-off connection usage. | Clarified protocol docs to reflect request/ack semantics over reusable control connections, added roundtrip serialization tests for `ConnectAccept`, `ConnectDecline`, and `TopicLeave`, and added cross-module parity test asserting `ControlPacketType` byte mapping aligns with `PacketType` variants and verification mode behavior. | `approved` | `implemented` | `cargo test -p harbor-core network::control::protocol --quiet` => 13 passed, 0 failed. | None. | Continue with `core/src/network/control/service.rs`. |
| 2026-02-12 | L5 | `core/src/network/control/service.rs` | `verified` | Control PoW verification used panic-prone mutex locking (`lock().unwrap()`), risking process abort on poisoned verifier state; top-level service docs/comment text had minor stale wording. | Replaced PoW verifier locking with poison-tolerant helper (`lock_pow_verifier`) and added a regression test validating poisoned-lock recovery; refreshed top-level flow wording and corrected `ConnectInvite` invalid-input test comment from base64 to hex. | `approved` | `implemented` | `cargo test -p harbor-core network::control::service --quiet` => 4 passed, 0 failed. | None. | Continue with `core/src/network/control/peers.rs`. |
| 2026-02-12 | L5 | `core/src/network/control/peers.rs` | `verified` | Incoming connect-request token path could auto-accept without successful token consumption; blocked check was fail-open on DB errors; `block_peer` did not persist blocked state for peers lacking existing connection rows; connect-decline handler emitted decline events even when no matching pending request and ignored DB update failures. Also had panic-prone control message encoding via `postcard::to_allocvec(...).unwrap()`. | Added fail-closed token consumption and blocked-state checks in `handle_connect_request`, switched `block_peer` to upsert blocked state for new/existing peers, made connect-accept/decline handlers enforce matching pending-outgoing request with DB-error differentiation, and replaced panic-prone postcard `unwrap()` calls with fallible encoding mapped to `ControlError::Rpc`; added focused helper tests for token consume behavior, blocked-state persistence, pending-request matching, and declined-state transition guards. | `approved` | `implemented` | `cargo test -p harbor-core network::control::peers --quiet` => 4 passed, 0 failed. | None. | Continue with `core/src/network/control/membership.rs`. |
| 2026-02-12 | L5 | `core/src/network/control/membership.rs` | `verified` | Incoming topic membership handlers could ack success after DB write failures (join/leave/remove), outbound control payload persistence used panic-prone `postcard::to_allocvec(...).unwrap()`, invite accept flow ignored member-insert errors, and incoming epoch values were not validated against local topic epoch state. | Added fallible control-message encoding helper mapped to `ControlError::Rpc`, made membership DB mutation failures fail-closed in join/leave/remove handlers, propagated member insert failures during invite acceptance, added stale-epoch guards for incoming join/leave and non-incrementing epoch rejection for remove-member, and added focused unit tests for encoding error mapping and epoch validation helpers. | `approved` | `implemented` | `cargo test -p harbor-core network::control::membership --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::control --quiet` => 39 passed, 0 failed. | None. | Continue with next L5 file. |
| 2026-02-12 | L5 | `core/src/network/control/lifecycle.rs` | `verified` | `join_topic` used panic-prone control payload encoding (`postcard::to_allocvec(...).unwrap()`), malformed invites could silently self-assign admin fallback, join announcements hardcoded epoch `0`, and invite relay metadata lookup errors were silently dropped. | Added fallible control-message encoding helper mapped to `ControlError::Rpc`, introduced explicit invite-shape validation for join flows, derived join announcement epoch from current local topic epoch state instead of hardcoded `0`, surfaced relay lookup DB failures with warning logs, and added focused helper tests for encode error mapping and invite/epoch validation logic. | `approved` | `implemented` | `cargo test -p harbor-core network::control::lifecycle --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::control --quiet` => 43 passed, 0 failed. | None. | Continue with `core/src/network/control/introductions.rs`. |
| 2026-02-12 | L5 | `core/src/network/control/introductions.rs` | `verified` | Outgoing suggest replication used panic-prone payload encoding (`postcard::to_allocvec(...).unwrap()`), and suggested-peer relay lookup DB errors were silently swallowed. | Added fallible control-message encoding helper mapped to `ControlError::Rpc`, surfaced relay lookup failures with warning logs while preserving best-effort behavior, and added focused helper tests for encode success/error mapping. | `approved` | `implemented` | `cargo test -p harbor-core network::control::introductions --quiet` => 2 passed, 0 failed; `cargo test -p harbor-core network::control --quiet` => 45 passed, 0 failed. | None. | Continue with next L5 file. |
| 2026-02-12 | L5 | `core/src/network/control/types.rs` | `verified` | Invite helper methods could propagate duplicate member IDs (risking downstream duplicate-recipient insert failures), legacy-only invite payloads had no effective member-info fallback for direct delivery call sites, and admin fallback performed unnecessary allocation. | Added stable deduplication for `member_ids`, introduced `effective_member_info` with legacy fallback + dedup semantics, made `admin_id` fallback non-allocating, clarified raw-vs-effective member-info docs, and added focused tests for duplicate/mixed/legacy invite behavior; companion lifecycle update switched join direct-delivery loop to `effective_member_info`. | `approved` | `implemented` | `cargo test -p harbor-core network::control::types --quiet` => 17 passed, 0 failed; `cargo test -p harbor-core network::control::lifecycle --quiet` => 4 passed, 0 failed; `cargo test -p harbor-core network::control --quiet` => 48 passed, 0 failed. | None. | Continue with `core/src/network/dht/mod.rs`. |
| 2026-02-12 | L5 | `core/src/network/dht/mod.rs` | `verified` | Facade/re-export module is structurally correct with no runtime logic defects; module docs had stale API/architecture references (nonexistent `create_dht_node` example and outdated lookup ownership phrasing). | Updated top-level docs to include `service` as the runtime entry point, clarified `internal::lookup` as compatibility-only, and replaced stale example with current `DhtService::start` + `lookup(target, None)` usage. | `approved` | `implemented` | `cargo test -p harbor-core network::dht --quiet` => 115 passed, 0 failed. | None. | Continue with `core/src/network/dht/protocol.rs`. |
| 2026-02-12 | L5 | `core/src/network/dht/protocol.rs` | `verified` | PoW wire-context contract was documented as sender-bound but outgoing DHT requests could compute PoW with a zero sender when `requester=None` (transient mode), risking false PoW rejection on receivers; FindNode response cap behavior also risked drift because protocol max constant was not consistently used by actor/DB fallback paths. | Bound outgoing FindNode PoW context to transport sender identity by threading explicit `sender_id` into `DhtService::send_find_node_on_conn` and updating DHT actor/iterative lookup call sites, centralized FindNode response capping with `MAX_FIND_NODE_RESULTS` in actor + DB fallback path (`core/src/handlers/dht.rs` companion edit), cleaned protocol docs/wording, removed unrelated `PoolError` protocol test, and added focused tests for sender-bound PoW context plus fail-closed decode behavior for legacy truncated FindNode payloads. | `approved` | `implemented` | `cargo test -p harbor-core network::dht::protocol --quiet` => 9 passed, 0 failed; `cargo test -p harbor-core handlers::dht --quiet` => 11 passed, 0 failed; `cargo test -p harbor-core network::dht::actor --quiet` => 26 passed, 0 failed; `cargo test -p harbor-core network::dht::service --quiet` => 1 passed, 0 failed. | None. | Continue with `core/src/network/dht/actor.rs`. |

## Decisions and Deferrals

| Date | Scope | Decision | Reason | Revisit After |
| --- | --- | --- | --- | --- |
|  |  |  |  |  |
